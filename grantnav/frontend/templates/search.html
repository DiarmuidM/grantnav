{% extends 'base.html' %}
{% load frontend %}
{% load static %}

{% block main_content %}

  <div class="row">
    <div class="col-xs-8 col-xs-offset-2">
      <form role="search">
        <div class="input-group">
          <input name="text_query" class="form-control search-box" placeholder="What are you searching for?" type="text" value="{{text_query}}">
          <span class="input-group-btn">
            <input class="search-icon" name="submit" src="{% static 'images/search_icon.png' %}" type="image" height="30px" width="30px">
          </span>
          <input name="json_query" class="form-control" type="hidden" value="{{json_query}}">
        </div>
        <div class="input-group search-checkbox-align">
          <div class="form-group">
            <div class="text-center">
              <label class="radio-inline">
                <input {% if default_field == "_all" %} checked {% endif %} type="radio" name="default_field" id="inlineRadio1" value="_all"> Search All Fields
              </label>
              <label class="radio-inline">
                <input {% if default_field == "recipientLocation" %} checked {% endif %} type="radio" name="default_field" id="inlineRadio2" value="recipientLocation"> Only Locations
              </label>
              <label class="radio-inline">
                <input {% if default_field == "recipientOrganization.name" %} checked {% endif %} type="radio" name="default_field" id="inlineRadio3" value="recipientOrganization.name"> Only Recipients
              </label>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>


  
  <div class="row">
    <div class="col-xs-3">
      <h3 class="indent"> Refine By {% if results.clear_all_facet_url %} <a href={{results.clear_all_facet_url}}> <small>(clear all)</small></a> {%endif%} </h3>
      <div class="panel panel-default">
        <a class="anchor" id="fundingOrganization"></a>
        <div class="panel-heading list-group-compact">
          Funding Organizations {% if results.aggregations.fundingOrganization.clear_url %} <a href={{results.aggregations.fundingOrganization.clear_url}}> <small>(clear)</small></a> {% endif%}
        </div>
        <div class="list-group">
          {% for bucket in results.aggregations.fundingOrganization.buckets %}
            <a href="{{bucket.url}}" class="list-group-item list-group-compact {% if bucket.selected %}list-group-item-success{%endif%}"> {{bucket.key|get_facet_org_name}} <small>({{bucket.doc_count|get_amount}})</small> </a>
          {% endfor %}

          {% if results.aggregations.fundingOrganization.buckets|length > 9 %}
            <a href="{{see_more_url.fundingOrganization.url}}" class="list-group-item list-group-compact"> <b>{% if see_more_url.fundingOrganization.more%}See More{% else %}See Less{% endif %}</b> </a>
          {% endif %}

        </div>
      </div>
      <div class="panel panel-default">
        <a class="anchor" id="recipientOrganization"></a>
        <div class="panel-heading list-group-compact">
          Recipient Organizations {% if results.aggregations.recipientOrganization.clear_url %} <a href={{results.aggregations.recipientOrganization.clear_url}}> <small>(clear)</small></a> {% endif%}
        </div>
        <div class="list-group">
          {% for bucket in results.aggregations.recipientOrganization.buckets %}
            <a href="{{bucket.url}}" class="list-group-item list-group-compact {% if bucket.selected %}list-group-item-success{%endif%}"> {{bucket.key|get_facet_org_name}} <small>({{bucket.doc_count|get_amount}})</small> </a>
          {% endfor %}
          {% if results.aggregations.recipientOrganization.buckets|length > 9 %}
            <a href="{{see_more_url.recipientOrganization.url}}" class="list-group-item list-group-compact"> <b>{% if see_more_url.recipientOrganization.more%}See More{% else %}See Less{% endif %}</b> </a>
          {% endif %}
        </div>
      </div>
      <div class="panel panel-default">
        <a class="anchor" id="recipientRegionName"></a>
        <div class="panel-heading list-group-compact">
          Recipient Region {% if results.aggregations.recipientRegionName.clear_url %} <a href="{{results.aggregations.recipientRegionName.clear_url}}"> <small>(clear)</small></a> {% endif%}
        </div>
        <div class="list-group">
          {% for bucket in results.aggregations.recipientRegionName.buckets %}
            <a href="{{bucket.url}}" class="list-group-item list-group-compact {% if bucket.selected %}list-group-item-success{%endif%}"> {{bucket.key}} <small>({{bucket.doc_count|get_amount}})</small> </a>
          {% endfor %}
        </div>
      </div>
      <div class="panel panel-default">
        <a class="anchor" id="recipientDistrictName"></a>
        <div class="panel-heading list-group-compact">
          Recipient District {% if results.aggregations.recipientDistrictName.clear_url %} <a href={{results.aggregations.recipientDistrictName.clear_url}}> <small>(clear)</small></a> {% endif%}
        </div>
        <div class="list-group">
          {% for bucket in results.aggregations.recipientDistrictName.buckets %}
            <a href="{{bucket.url}}" class="list-group-item list-group-compact {% if bucket.selected %}list-group-item-success{%endif%}"> {{bucket.key}} <small>({{bucket.doc_count|get_amount}})</small> </a>
          {% endfor %}
          {% if results.aggregations.recipientDistrictName.buckets|length > 9 %}
            <a href="{{see_more_url.recipientDistrictName.url}}" class="list-group-item list-group-compact"> <b>{% if see_more_url.recipientDistrictName.more%}See More{% else %}See Less{% endif %}</b> </a>
          {% endif %}
        </div>
      </div>
      <div class="panel panel-default">
        <a class="anchor" id="amountAwareded"></a>
        <div class="panel-heading list-group-compact">
          Amount Awarded {% if results.aggregations.amountAwarded.clear_url %} <a href="{{results.aggregations.amountAwarded.clear_url}}"> <small>(clear)</small></a> {% endif%}
        </div>
        <div class="list-group">
          {% if amount_range %}
            <a href="{{results.aggregations.amountAwarded.clear_url}}" class="list-group-item list-group-compact list-group-item-success"> {{amount_range|get_amount_range}} </a>
          {% endif %}
          {% for bucket in results.aggregations.amountAwarded.buckets %}
            <a href="{{bucket.url}}" class="list-group-item list-group-compact {% if bucket.selected %}list-group-item-success{%endif%}"> {{bucket|get_amount_range}} <small>({{bucket.doc_count|get_amount}})</small> </a>
          {% endfor %}
        </div>
      </div>
      <div class="panel panel-default">
        <a class="anchor" id="amountAwarededFixed"></a>
        <div class="panel-heading list-group-compact">
          Amount Awarded Fixed {% if results.aggregations.amountAwardedFixed.clear_url %} <a href="{{results.aggregations.amountAwardedFixed.clear_url}}"> <small>(clear)</small></a> {% endif%}
        </div>
        <div class="list-group">
          {% for bucket in results.aggregations.amountAwardedFixed.buckets %}
            <a href="{{bucket.url}}" class="list-group-item list-group-compact {% if bucket.selected %}list-group-item-success{%endif%}"> {{bucket|get_amount_range}} <small>({{bucket.doc_count|get_amount}})</small> </a>
          {% endfor %}
        </div>
      </div>
      <div class="panel panel-default">
        <a class="anchor" id="awardYear"></a>
        <div class="panel-heading list-group-compact">
          Award Year {% if results.aggregations.awardYear.clear_url %} <a href="{{results.aggregations.awardYear.clear_url}}"> <small>(clear)</small></a> {% endif%}
        </div>
        <div class="list-group">
          {% for bucket in results.aggregations.awardYear.buckets %}
          <a href="{{bucket.url}}" class="list-group-item list-group-compact {% if bucket.selected %}list-group-item-success{%endif%}">
            {% if bucket.from_as_string %} {{bucket.from_as_string}} {% else %} {{bucket.key}} {% endif %} <small>({{bucket.doc_count|get_amount}})</small> </a>
          {% endfor %}
        </div>
      </div>
    </div>
    
    {% if results and results.hits.hits %}
    <div class="col-xs-9">
      <h3 class="indent"> Results <small>
        <a href="{% url 'search.csv' %}?{{ query_string }}">
          <img src="{% static 'images/csv_download_icon.png' %}" alt="Download CSV" class="download_button" id="csv_download_button"/>
        </a>
        <a href="{% url 'search.json' %}?{{ query_string }}">
          <img src="{% static 'images/json_download_icon.png' %}" alt="Download JSON" class="download_button" id="json_download_button"/>
        </a>
      </h3>
         <div class="panel panel-default">
            <div class="panel-body panel-no-padding">
              <div class="row">
                <div class="col-sm-6">
                  <dl class="dl-horizontal top-stats-search">
                    <dt> Total Grants: </dt> <dd>{{results.hits.total|get_amount}} </dd>
                    <dt>Total funders</dt> <dd>{{results.aggregations.funding_orgs.value|get_amount}}</dd>
                    <dt>Total recipients</dt> <dd>{{results.aggregations.recipient_orgs.value|get_amount}}</dd>
                    <dt>Total awarded</dt> <dd>£{{results.aggregations.total_amount.value|get_amount}}</dd>
                  </dl>
                </div>
                <div class="col-sm-6">
                  <dl class="dl-horizontal top-stats-search">
                     <dt>Largest award</dt> <dd>£{{results.aggregations.max_amount.value|get_amount}}</dd>
                     <dt>Smallest award</dt> <dd>£{{results.aggregations.min_amount.value|get_amount}}</dd>
                     <dt>Earliest award date</dt> <dd>{{results.aggregations.min_date.value_as_string|get_date}}</dd>
                     <dt>Latest award date</dt> <dd>{{results.aggregations.max_date.value_as_string|get_date}}</dd>
                  </dl>
                </div>
              </div>
            </div>
         </div>

      {% for result in results.hits.hits %}
         <div class="panel panel-default">
            <div class="panel-body panel-less-padding">
              <div class="row">
                <div class="col-xs-6">
                  <h4 class="heading-in-panel">
                    <a href="{% url 'grant' result.source.id %}">
                      {{ result.source|get_title }}
                    </a>
                    <small class="pull-right"> {{result.source.awardDate|get_date}} </small>
                  </h4>
                  <p> {{ result.source.description }} </p>
                </div>

                {% if result.source.fundingOrganization.0.id and result.source.recipientOrganization.0.id %}
                <div class="col-xs-6">
                  <div class="panel panel-default">
                    <div class="panel-body">
                      <b>Amount: </b> {{result.source|get_currency}}{{result.source.amountAwarded|get_amount}} <br/>
                      <b>Funder: </b> <a href="{% url 'funder' result.source.fundingOrganization.0.id %}">{{ result.source.fundingOrganization.0 | get_name }}</a> <br/>
                      <b>Recipient: </b> <a href="{% url 'recipient' result.source.recipientOrganization.0.id %}">{{ result.source.recipientOrganization.0|get_name|truncatechars:40 }} </a> <br/>
                      {% if result.source.recipientRegionName %}
                        <b>Region: </b> <a href="{% url 'region' result.source.recipientRegionName %}">{{ result.source.recipientRegionName }} </a> <br/>
                      {% endif %}
                      {% if result.source.recipientRegionName %}
                        <b>District: </b> <a href="{% url 'district' result.source.recipientDistrictName %}">{{ result.source.recipientDistrictName }} </a> <br/>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
         </div>
      {% endfor %}

      {% if next_page or prev_page %}
        <nav>
          <ul class="pager">
            {% if prev_page %}
            <li class="previous"><a href="{{prev_page}}"><span aria-hidden="true">&larr;</span>Previous</a></li>
            {% endif %}
            {% if next_page %}
            <li class="next"><a href="{{next_page}}">Next<span aria-hidden="true">&rarr;</span></a></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>

  {% elif results %}

     <div class="col-xs-9">
        <div id="no-results">
          <h1>No Results</h1>
          <p>Your search - <strong>"{{text_query}}"</strong> - did not match any records.<br>Try something like</p>
          <ul>
          <li>Using more general terms</li>
          <li>Checking your spelling</li>
          </ul>
        </div>
     </div>
  
  {% elif search_error %}
   
     <div class="col-xs-9">
        <div id="not_valid">
          <h1>Search input is not valid</h1>
          <p>We can't find what you tried to search for.<br>Try something like:</p>
          <ul>
          <li>Using more general terms</li>
          <li>Checking your spelling</li>
        </div>
     </div>
   
  {% endif %}
    
  </div>
</div>


{% endblock %}

{% block extrapiwik %}
_paq.push(["trackSiteSearch", "{{text_query}}", false, {{results.hits.total}}]);
{% endblock %}
