{% extends 'base.html' %}

{% load frontend %}
{% load static %}

{% block main_content %}

<div class="row">
  <div class="col-md-4">
    <h1 class="funder-header text-center">
      {{ recipient.id_and_name|get_facet_org_name }}
    </h1>
  </div>
  <div class="col-md-8">
   <div class="row">
     <div class="col-xs-6">
       <dl class="dl-horizontal top-stats">
         <dt>Total grants</dt> <dd>{{results.hits.total|get_amount}}</dd>
         <dt>Total funders</dt> <dd>{{results.aggregations.funder_orgs.value|get_amount}}</dd>
         <dt>Earliest award date</dt> <dd>{{results.aggregations.min_date.value_as_string|get_date}}</dd>
         <dt>Latest award date</dt> <dd>{{results.aggregations.max_date.value_as_string|get_date}}</dd>
       </dl>
     </div>
     <div class="col-xs-6">
       <dl class="dl-horizontal top-stats">
          {% with currency=results.aggregations.currency_stats.buckets|first|get:"key"|upper buckets=results.aggregations.currency_stats.buckets%}
            <dt>Total {{currency}} grants</dt> <dd>{{buckets|first|get:"amount_stats"|get:"count"|get_amount}}</dd>
            <dt>Total {{currency}} awarded</dt> <dd>{{currency|currency_symbol}}{{buckets|first|get:"amount_stats"|get:"sum"|get_amount}}</dd>
            <dt>Largest {{currency}} award</dt> <dd>{{currency|currency_symbol}}{{buckets|first|get:"amount_stats"|get:"max"|get_amount}}</dd>
            <dt>Smallest {{currency}} award</dt> <dd>{{currency|currency_symbol}}{{buckets|first|get:"amount_stats"|get:"min"|get_amount}}</dd>
            <dt>Total Non-{{currency}} grants</dt> 
            <dd>
            {% with total_other=buckets|first|get:"amount_stats"|get:"count"|reverse_minus:results.hits.total %}
              {% if total_other %}
                <a class="javascript-enabled" id="other-currencies-modal" data-toggle="modal" data-target="#summary-info-model">
                  {{total_other|get_amount}}
                </a>
                <noscript>
                  {{total_other|get_amount}}
                </noscript>
              {% else %}
                0
              {% endif %}
            {% endwith %}
            </dd>
          {% endwith %}
       </dl>
     </div>
   </div>
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <div class="panel panel-info">
      <div class="panel-heading">
        Grants
        <a class="pull-right" href="{% url 'recipient.json' recipient.id %}">
          <img src="{% static 'images/json_download_icon.png' %}" alt="Download JSON" class="download_button"/>
        </a>
        <a class="pull-right" href="{% url 'recipient.csv' recipient.id %}">
          <img src="{% static 'images/csv_download_icon.png' %}" alt="Download CSV" class="download_button"/>
        </a>

      </div>
      <div class="panel-body">
        <table class="table table-condensed table-bordered table-striped dt-responsive" id="grants_datatable" width="100%">
          <thead>
            <tr>
              <th>Date</th>
              <th>Amount</th>
              <th>Funder</th>
              <th>Title</th>
              <th>Description</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_style %}
   <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.10/css/dataTables.bootstrap.min.css">
   <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.0.2/css/responsive.dataTables.min.css">
   <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/scroller/1.4.1/css/scroller.dataTables.min.css">
{% endblock %}

{% block extra_scripts %}
   <script type="text/javascript" src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
   <script type="text/javascript" src="https://cdn.datatables.net/1.10.10/js/dataTables.bootstrap.min.js"></script>
   <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.0.2/js/dataTables.responsive.min.js"></script>
   <script type="text/javascript" src="https://cdn.datatables.net/scroller/1.4.1/js/dataTables.scroller.min.js"></script>

   <script>
    function truncate(string, len){
       if (string.length > len)
          return string.substring(0,len)+'...';
       else
          return string;
    };

   jQuery(function($) {
     $('#grants_datatable').dataTable({
       "serverSide": true,
       "responsive": true,
       "searching": true,
       "autoWidth": false,
       "scrollY": 400,
       "scroller": true,
       "dom": "fit",
       "scroller": {"displayBuffer": 20,
                    "loadingIndicator": true},
       "order": [[0, "desc"]],
       "language": {
           "info": "_START_ to _END_ of _TOTAL_",
           "search": "Search All Fields"
       },
       "ajax": {
         "url": "{% url 'grants_datatables' %}",
         "data": function ( d ) {
           d.recipient = "{{recipient.id|escapejs}}";
         }
       },
       "columns": [
         {"data": "awardDate"},
         {"data": "amountAwarded", "className": "amount"},
         {"data": "fundingOrganization.0.name", "render": function (data, type, row) {return '<a href="/funder/' + encodeURIComponent(row.fundingOrganization[0].id) + '">' + truncate(data, 60) + '</a>'}},
         {"data": "title",
          "orderable": false,
          "render": function (data, type, row) {
             return '<a href="/grant/' + encodeURIComponent(row.id) + '">' + truncate(data, 60) + '</a>'
         }},
         {"data": "description"},
       ]
     });
   })
   </script>
{% endblock %}

{% block models %}
  {% include 'currency_stats_modal.html' %}
{% endblock %}
